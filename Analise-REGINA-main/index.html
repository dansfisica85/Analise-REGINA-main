<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema REGINA 2025 (Registros Educacionais Gerais e Índices Avaliativos) - Dashboard Principal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .chart-container { position: relative; height: 300px; margin: 20px 0; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header com KPIs Dinâmicos -->
    <header class="gradient-bg text-white">
        <div class="container mx-auto px-6 py-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold mb-2">🎯 Sistema REGINA 2025</h1>
                    <p class="text-lg opacity-95 font-medium">(Registros Educacionais Gerais e Índices Avaliativos)</p>
                    <p class="text-xl opacity-90">Dashboard Principal • Análise Educacional Integrada</p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold">2025</div>
                    <p class="text-sm opacity-75">Sistema Funcional</p>
                </div>
            </div>
            <div class="mt-6 grid md:grid-cols-4 gap-4 text-center">
                <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                    <div id="total-escolas" class="text-2xl font-bold">26</div>
                    <p class="text-sm opacity-75">Escolas Analisadas</p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                    <div id="frequencia-media" class="text-2xl font-bold">93.8%</div>
                    <p class="text-sm opacity-75">Frequência Média (3º Bim)</p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                    <div id="score-medio" class="text-2xl font-bold">8.79</div>
                    <p class="text-sm opacity-75">Score Super BI (3º Bim)</p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                    <div id="melhoria-geral" class="text-2xl font-bold">+0.72</div>
                    <p class="text-sm opacity-75">Evolução 1º→3º Bimestre</p>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Visão Geral da Rede -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">📊 Visão Geral da Rede</h2>
            
            <!-- Análise Estatística -->
            <div class="max-w-4xl mx-auto mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 text-center sm:text-left">📊 Análise Estatística</h3>
                        <div class="mt-3 sm:mt-0 flex flex-col sm:flex-row gap-2">
                            <a href="novopag.html" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium text-sm rounded-lg transition-colors duration-200 shadow-sm hover:shadow-md">
                                <span class="mr-2">📈</span>
                                ANÁLISE REFINADA
                            </a>
                            
                            <!-- BOTÃO DESTAQUE COMPILADO 3 BIMESTRES -->
                            <div class="relative inline-block">
                                <div class="absolute inset-0 bg-gradient-to-r from-yellow-400 via-orange-400 to-red-400 rounded-2xl blur-lg opacity-75 animate-pulse"></div>
                                <a href="comparacao-escolas.html" 
                                   class="relative bg-gradient-to-r from-yellow-500 via-orange-500 to-red-500 hover:from-yellow-600 hover:via-orange-600 hover:to-red-600 text-white font-bold py-6 px-12 rounded-2xl shadow-2xl transform hover:scale-105 transition-all duration-300 border-4 border-white inline-block">
                                    <span class="text-3xl block mb-2">📊 COMPILADO TOTAL</span>
                                    <span class="text-xl block">Evolução Completa - 1º, 2º e 3º Bimestres</span>
                                    <span class="text-sm block mt-2 opacity-90">Clique aqui para visualizar a evolução das 26 escolas</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="text-lg font-semibold text-gray-700">Diferença Média:</div>
                            <div id="diferenca-score" class="text-2xl font-bold text-blue-600">+5.9</div>
                            <div class="text-sm text-gray-500">PEI vs Regular</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-semibold text-gray-700">Melhor Performance:</div>
                            <div class="text-2xl font-bold text-green-600">PEI</div>
                            <div class="text-sm text-gray-500">Em todos os componentes</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-semibold text-gray-700">Taxa de Excelência:</div>
                            <div id="taxa-excelencia" class="text-2xl font-bold text-purple-600">78%</div>
                            <div class="text-sm text-gray-500">PEI ≥85 vs 35% Regular</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Geral das 26 Escolas -->
            <div class="w-full">
                <div class="bg-white p-6 rounded-lg shadow-md card">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6 text-center">📈 Performance Geral - 26 Escolas (1º vs 2º Bimestre)</h3>
                    
                    <!-- Container com scroll horizontal para visualização em dispositivos menores -->
                    <div class="overflow-x-auto">
                        <div style="min-width: 1200px;">
                            <canvas id="graficoPerformanceGeral" style="height: 500px;"></canvas>
                        </div>
                    </div>
                    
                    <!-- Legenda e informações adicionais -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-lg font-bold text-blue-600">1º Bimestre</div>
                            <div class="text-sm text-blue-700">Média: 7.6 pontos</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="text-lg font-bold text-green-600">2º Bimestre</div>
                            <div class="text-sm text-green-700">Média: 9.1 pontos</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-lg font-bold text-purple-600">Evolução</div>
                            <div class="text-sm text-purple-700">+1.5 pontos (+19.7%)</div>
                        </div>
                    </div>
                    
                    <!-- Notas explicativas -->
                    <div class="mt-4 text-xs text-gray-500 text-center">
                        <p>💡 <strong>Dica de Visualização:</strong> Passe o mouse sobre as barras para ver dados detalhados de cada escola</p>
                        <p>🎯 <strong>Cores:</strong> Azul = 1º Bimestre | Verde = 2º Bimestre | PEI destacadas com bordas mais escuras</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- CONTEÚDO EXATO DO GEMINI.HTML -->
        
        <!-- Visão Geral da Rede -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Visão Geral da Rede</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 max-w-5xl mx-auto">
                <div class="bg-white p-6 rounded-lg shadow-sm kpi-card border-l-4 border-indigo-500" style="transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;">
                    <h3 class="text-sm font-medium text-slate-500">Média Desempenho (2º Bi)</h3>
                    <p class="text-3xl font-bold text-slate-800 mt-1">9.1 <span class="text-base font-medium text-green-500 ml-1">+1.5</span></p>
                    <p class="text-xs text-slate-400 mt-1">vs 1º Bimestre</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm kpi-card border-l-4 border-teal-500" style="transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;">
                    <h3 class="text-sm font-medium text-slate-500">Média Frequência (2º Bi)</h3>
                    <p class="text-3xl font-bold text-slate-800 mt-1">85.9% <span class="text-base font-medium text-green-500 ml-1">+5.2%</span></p>
                    <p class="text-xs text-slate-400 mt-1">vs 1º Bimestre (Dados Corrigidos)</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm kpi-card border-l-4 border-amber-500" style="transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;">
                    <h3 class="text-sm font-medium text-slate-500">Escolas Analisadas</h3>
                    <p class="text-3xl font-bold text-slate-800 mt-1">26</p>
                    <p class="text-xs text-slate-400 mt-1">9 PEI (7+2) e 17 Regulares</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="font-bold text-slate-700 mb-4">Evolução da Rede: 1º vs 2º Bimestre</h3>
                <div class="chart-container h-80" style="position: relative; width: 100%; margin: auto; height: 400px;">
                    <canvas id="networkEvolutionChartMain"></canvas>
                </div>
            </div>
        </section>

        <!-- Análise Detalhada por Escola -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Análise Detalhada por Escola</h2>
            <div class="bg-white rounded-lg shadow-sm p-6 overflow-x-auto">
                 <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 table-header-sortable cursor-pointer" data-sort="nome">Escola</th>
                            <th scope="col" class="px-6 py-3 text-center table-header-sortable cursor-pointer" data-sort="desempenho2">Desempenho 2º Bi</th>
                            <th scope="col" class="px-6 py-3 text-center table-header-sortable cursor-pointer" data-sort="variacao_acad">Evolução Acad.</th>
                            <th scope="col" class="px-6 py-3 text-center table-header-sortable cursor-pointer" data-sort="frequencia2">Frequência 2º Bi</th>
                            <th scope="col" class="px-6 py-3 text-center table-header-sortable cursor-pointer" data-sort="variacao_freq">Evolução Freq.</th>
                        </tr>
                    </thead>
                    <tbody id="school-table-body-main">
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Análise de Evolução Individual com IA -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Análise de Evolução Individual com IA</h2>
            <div class="mb-4">
                <label for="evolution-school-selector-main" class="block text-sm font-medium text-slate-600">Selecione uma Escola para Análise</label>
                <select id="evolution-school-selector-main" class="mt-1 block w-full max-w-lg pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
            </div>
            <div id="school-evolution-container-main" class="bg-white p-6 rounded-lg shadow-sm">
                <!-- Conteúdo dinâmico aqui -->
            </div>
        </section>

        <!-- Simulador de Projeção Super BI -->
        <section class="mb-12">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800">Simulador de Projeção Super BI</h2>
                <p class="text-gray-600 max-w-2xl mx-auto mt-2">Ajuste os indicadores para projetar a nota final de cada escola, com base nas regras de 2025.</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="font-semibold text-slate-800 mb-4">Parâmetros da Simulação</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="school-selector-main" class="block text-sm font-medium text-slate-600">Selecione a Escola</label>
                            <select id="school-selector-main" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                        </div>
                        <div>
                            <label for="frequencia-slider-main" class="block text-sm font-medium text-slate-600">Frequência Aluno (%) <span id="frequencia-value-main" class="font-bold text-indigo-600"></span></label>
                            <input type="range" id="frequencia-slider-main" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-slider" min="70" max="100" step="0.1" style="-webkit-appearance: none; appearance: none;">
                            <div class="text-xs text-gray-500 mt-1">Peso máximo: 1.5 pontos</div>
                        </div>
                        <div>
                            <label for="professor-freq-slider-main" class="block text-sm font-medium text-slate-600">Frequência Professor (%) <span id="professor-freq-value-main" class="font-bold text-indigo-600"></span></label>
                            <input type="range" id="professor-freq-slider-main" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-slider" min="80" max="100" step="0.1" style="-webkit-appearance: none; appearance: none;" value="95">
                            <div class="text-xs text-gray-500 mt-1">Peso máximo: 1.0 ponto</div>
                        </div>
                        <div>
                            <label for="plataformas-slider-main" class="block text-sm font-medium text-slate-600">Nota Plataformas (0-10) <span id="plataformas-value-main" class="font-bold text-indigo-600"></span></label>
                            <input type="range" id="plataformas-slider-main" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-slider" min="0" max="10" step="0.1" style="-webkit-appearance: none; appearance: none;">
                            <div class="text-xs text-gray-500 mt-1">Peso máximo: 2.0 pontos</div>
                        </div>
                        <div>
                            <label for="formacao-slider-main" class="block text-sm font-medium text-slate-600">Formação - PdA + Multiplica (%) <span id="formacao-value-main" class="font-bold text-indigo-600"></span></label>
                            <input type="range" id="formacao-slider-main" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-slider" min="0" max="100" step="1" style="-webkit-appearance: none; appearance: none;" value="80">
                            <div class="text-xs text-gray-500 mt-1">Peso máximo: 2.0 pontos</div>
                        </div>
                         <div>
                            <label for="saresp-slider-main" class="block text-sm font-medium text-slate-600">SARESP - IC Meta (%) <span id="saresp-value-main" class="font-bold text-indigo-600"></span></label>
                            <input type="range" id="saresp-slider-main" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-slider" min="0" max="100" step="1" style="-webkit-appearance: none; appearance: none;" value="70">
                            <div class="text-xs text-gray-500 mt-1">Peso máximo: 3.0 pontos</div>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="font-semibold text-slate-800 mb-4">Resultado da Projeção e Plano de Ação</h3>
                    <div class="text-center">
                        <p class="text-slate-500">Nota Final Super BI Projetada</p>
                        <p id="projected-score-main" class="text-6xl font-extrabold text-indigo-600 my-4">0.0</p>
                        <div class="chart-container h-64" style="position: relative; width: 100%; margin: auto; height: 400px;">
                            <canvas id="projectionChartMain"></canvas>
                        </div>
                    </div>
                    <div class="mt-6 pt-6 border-t border-slate-200">
                        <h4 class="text-lg font-semibold text-slate-800 mb-3">Plano de Ação com IA</h4>
                        <button id="generate-plan-btn-main" class="inline-flex items-center gap-2 px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 disabled:opacity-50">
                            <span id="plan-btn-text-main">✨ Sugerir Plano de Ação</span>
                            <div id="plan-btn-spinner-main" class="spinner hidden" style="border: 2px solid rgba(0, 0, 0, 0.1); border-left-color: #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite;"></div>
                        </button>
                        <div id="ai-plan-container-main" class="mt-4 p-4 bg-slate-50 rounded-lg text-slate-600 text-sm hidden prose prose-sm max-w-none">
                            <div id="ai-plan-content-main"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-6 text-center">
            <p class="mb-2">Sistema de Análise Educacional REGINA 2025</p>
            <p class="text-gray-400 text-sm">CRIADO POR PROFESSOR DAVI - PEC TECNOLOGIA - davi.silva@educacao.sp.gov.br</p>
            <p class="text-gray-400 text-sm">Secretaria de Estado da Educação de São Paulo</p>
            <p class="text-gray-400 text-xs mt-2">✅ Gráficos funcionais • ✅ Dados dinâmicos • ✅ Sistema completo</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="dados.js"></script>
    <script src="graficos.js"></script>
    
    <!-- Scripts específicos do sistema avançado -->
    <script>
        // API Key do Gemini (substitua pela sua chave real)
        const GEMINI_API_KEY = 'SUA_CHAVE_API_AQUI';

        // Estilo para KPI cards com hover
        document.addEventListener('DOMContentLoaded', function() {
            const kpiCards = document.querySelectorAll('.kpi-card');
            kpiCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.15)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                });
            });
        });

        // Estilos para sliders
        const style = document.createElement('style');
        style.textContent = `
            .range-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                height: 20px;
                width: 20px;
                border-radius: 50%;
                background: #6366f1;
                cursor: pointer;
                box-shadow: 0 0 2px 0 #555;
                transition: background .15s ease-in-out;
            }
            .range-slider::-webkit-slider-thumb:hover {
                background: #4f46e5;
            }
            .range-slider::-moz-range-thumb {
                height: 20px;
                width: 20px;
                border-radius: 50%;
                background: #6366f1;
                cursor: pointer;
                border: none;
                box-shadow: 0 0 2px 0 #555;
            }
            .spinner {
                border: 2px solid rgba(0, 0, 0, 0.1);
                border-left-color: #fff;
                border-radius: 50%;
                width: 16px;
                height: 16px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // Dados das escolas para funcionalidades avançadas
        const schoolDataMain = [
            { id: 1, nome: "PEI - José Luiz de Siqueira", tipo: "PEI", desempenho1: 8.1, desempenho2: 8.3, frequencia1: 93.2, frequencia2: 94.1, alunos: 742 },
            { id: 2, nome: "EE Luiz Marcari", tipo: "Regular", desempenho1: 6.6, desempenho2: 8.6, frequencia1: 71.3, frequencia2: 86.1, alunos: 249 },
            { id: 3, nome: "PEI - Nestor Gomes de Araújo", tipo: "PEI", desempenho1: 8.3, desempenho2: 9.9, frequencia1: 81.8, frequencia2: 90.6, alunos: 306 },
            { id: 4, nome: "EE Dr. Mário Lins", tipo: "Regular", desempenho1: 7.8, desempenho2: 9.3, frequencia1: 85.8, frequencia2: 86.7, alunos: 105 },
            { id: 5, nome: "EE Prof. Plínio Berardo", tipo: "Regular", desempenho1: 6.6, desempenho2: 8.6, frequencia1: 73.7, frequencia2: 75.2, alunos: 1038 },
            { id: 6, nome: "PEI - Domingos Paro", tipo: "PEI", desempenho1: 8.1, desempenho2: 10.0, frequencia1: 88.0, frequencia2: 93.2, alunos: 254 },
            { id: 7, nome: "PEI - Maria Falconi de Felício", tipo: "PEI", desempenho1: 8.7, desempenho2: 10.0, frequencia1: 85.9, frequencia2: 90.6, alunos: 396 },
            { id: 8, nome: "EE Maurício Montecchi", tipo: "Regular", desempenho1: 7.4, desempenho2: 9.9, frequencia1: 91.0, frequencia2: 92.0, alunos: 815 },
            { id: 9, nome: "EE Orminda Guimarães Cotrim", tipo: "Regular", desempenho1: 7.0, desempenho2: 9.5, frequencia1: 84.4, frequencia2: 84.5, alunos: 779 },
            { id: 10, nome: "EE Prof. Basílio Rodrigues da Silva", tipo: "Regular", desempenho1: 6.6, desempenho2: 8.8, frequencia1: 83.4, frequencia2: 88.4, alunos: 571 },
            { id: 11, nome: "PEI - Dolores Belém Novaes", tipo: "PEI", desempenho1: 7.9, desempenho2: 9.5, frequencia1: 82.8, frequencia2: 89.2, alunos: 503 },
            { id: 12, nome: "EE Profª Dolores Martins de Castro", tipo: "Regular", desempenho1: 6.6, desempenho2: 9.2, frequencia1: 89.7, frequencia2: 91.5, alunos: 148 },
            { id: 13, nome: "EE Profª Josepha Castro", tipo: "Regular", desempenho1: 6.2, desempenho2: 9.4, frequencia1: 82.9, frequencia2: 82.3, alunos: 527 },
            { id: 14, nome: "EE Profª Yolanda Luiz Sichieri", tipo: "Regular", desempenho1: 7.1, desempenho2: 9.5, frequencia1: 71.9, frequencia2: 78.6, alunos: 642 },
            { id: 15, nome: "EE Dona Adélia Frascino", tipo: "Regular", desempenho1: 7.8, desempenho2: 10.0, frequencia1: 91.5, frequencia2: 92.6, alunos: 50 },
            { id: 16, nome: "EE Anna Passamonti Balardin", tipo: "Regular", desempenho1: 6.0, desempenho2: 9.2, frequencia1: 73.1, frequencia2: 78.4, alunos: 968 },
            { id: 17, nome: "PEI - Dr. Antônio Furlan Júnior", tipo: "PEI", desempenho1: 8.0, desempenho2: 9.8, frequencia1: 88.4, frequencia2: 89.3, alunos: 521 },
            { id: 18, nome: "EE Prof. Bruno Pieroni", tipo: "Regular", desempenho1: 7.6, desempenho2: 9.8, frequencia1: 82.9, frequencia2: 85.5, alunos: 645 },
            { id: 19, nome: "EE Profª Edith Silveira Dalmaso", tipo: "Regular", desempenho1: 6.4, desempenho2: 8.5, frequencia1: 75.3, frequencia2: 90.8, alunos: 1058 },
            { id: 20, nome: "EE Ferrúcio Chiaratti", tipo: "Regular", desempenho1: 5.9, desempenho2: 9.0, frequencia1: 70.9, frequencia2: 74.8, alunos: 902 },
            { id: 21, nome: "EE Dr. Isaías José Ferreira", tipo: "Regular", desempenho1: 6.7, desempenho2: 9.6, frequencia1: 78.9, frequencia2: 88.0, alunos: 631 },
            { id: 22, nome: "PEI - Maria Conceição R. Silva Magon", tipo: "PEI", desempenho1: 7.2, desempenho2: 9.4, frequencia1: 70.8, frequencia2: 93.4, alunos: 236 },
            { id: 23, nome: "EE Profª Nícia Fabíola Zanutto Giraldi", tipo: "Regular", desempenho1: 7.1, desempenho2: 9.2, frequencia1: 80.9, frequencia2: 80.5, alunos: 769 },
            { id: 24, nome: "PEI - Winston Churchill", tipo: "PEI", desempenho1: 7.2, desempenho2: 9.5, frequencia1: 80.1, frequencia2: 87.6, alunos: 386 },
            { id: 25, nome: "PEI - Maria Élyde Mônaco dos Santos", tipo: "PEI", desempenho1: 8.3, desempenho2: 10.0, frequencia1: 82.2, frequencia2: 88.2, alunos: 229 },
            { id: 26, nome: "EE Odulfo de Oliveira Guimarães", tipo: "Regular", desempenho1: 7.0, desempenho2: 9.3, frequencia1: 76.2, frequencia2: 80.0, alunos: 897 }
        ].map(d => ({
            ...d,
            variacao_acad: parseFloat((d.desempenho2 - d.desempenho1).toFixed(1)),
            variacao_freq: parseFloat((d.frequencia2 - d.frequencia1).toFixed(1))
        }));

        // Gráfico de evolução da rede principal
        let networkEvolutionChartMain;
        
        function createNetworkEvolutionChartMain() {
            const ctx = document.getElementById('networkEvolutionChartMain');
            if (!ctx) return;
            
            if (networkEvolutionChartMain) networkEvolutionChartMain.destroy();
            
            networkEvolutionChartMain = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1º Bimestre', '2º Bimestre'],
                    datasets: [{
                        label: 'Média de Desempenho',
                        data: [7.6, 9.1],
                        backgroundColor: 'rgba(79, 70, 229, 0.7)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'Média de Frequência (%)',
                        data: [80.7, 85.9],
                        backgroundColor: 'rgba(13, 148, 136, 0.7)',
                        borderColor: 'rgba(13, 148, 136, 1)',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            position: 'left', 
                            title: { display: true, text: 'Média de Desempenho' }
                        },
                        y1: { 
                            beginAtZero: false, 
                            position: 'right', 
                            title: { display: true, text: 'Média de Frequência (%)' },
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolução da Rede Estadual - 1º vs 2º Bimestre'
                        }
                    }
                }
            });
        }

        // Popular tabela com dados das escolas
        function populateMainTable(data) {
            const tableBody = document.getElementById('school-table-body-main');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            data.forEach(school => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50';
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-900">${school.nome}</td>
                    <td class="px-6 py-4 text-center">${school.desempenho2.toFixed(1)}</td>
                    <td class="px-6 py-4 text-center ${school.variacao_acad >= 0 ? 'text-green-600' : 'text-red-600'}">${school.variacao_acad > 0 ? '+' : ''}${school.variacao_acad.toFixed(1)}</td>
                    <td class="px-6 py-4 text-center">${school.frequencia2.toFixed(1)}%</td>
                    <td class="px-6 py-4 text-center ${school.variacao_freq >= 0 ? 'text-green-600' : 'text-red-600'}">${school.variacao_freq > 0 ? '+' : ''}${school.variacao_freq.toFixed(1)}%</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Ordenação da tabela principal
        let currentSortMain = { key: 'nome', direction: 'asc' };
        function setupMainTableSorting() {
            document.querySelectorAll('.table-header-sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sort;
                    const direction = (currentSortMain.key === sortKey && currentSortMain.direction === 'desc') ? 'asc' : 'desc';
                    currentSortMain = { key: sortKey, direction };
                    const sortedData = [...schoolDataMain].sort((a, b) => {
                        if (a[sortKey] < b[sortKey]) return direction === 'asc' ? -1 : 1;
                        if (a[sortKey] > b[sortKey]) return direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                    populateMainTable(sortedData);
                });
            });
        }

        // Análise de evolução individual
        function initializeEvolutionAnalysis() {
            const schoolSelector = document.getElementById('evolution-school-selector-main');
            if (!schoolSelector) return;

            // Popular seletor de escolas
            schoolDataMain.forEach(school => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.nome;
                schoolSelector.appendChild(option);
            });

            schoolSelector.addEventListener('change', (e) => {
                const school = schoolDataMain.find(s => s.id == e.target.value);
                if (school) {
                    displayEvolutionAnalysis(school);
                }
            });

            // Exibir primeira escola por padrão
            if (schoolDataMain.length > 0) {
                schoolSelector.value = schoolDataMain[0].id;
                displayEvolutionAnalysis(schoolDataMain[0]);
            }
        }

        function displayEvolutionAnalysis(school) {
            const container = document.getElementById('school-evolution-container-main');
            if (!container) return;
            
            const academicTrend = school.variacao_acad >= 0 ? 'Melhoria' : 'Queda';
            const frequencyTrend = school.variacao_freq >= 0 ? 'Melhoria' : 'Queda';
            const academicColor = school.variacao_acad >= 0 ? 'text-green-600' : 'text-red-600';
            const frequencyColor = school.variacao_freq >= 0 ? 'text-green-600' : 'text-red-600';

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-slate-800 mb-2">Desempenho Acadêmico</h4>
                        <div class="flex items-center justify-between">
                            <span class="text-2xl font-bold ${academicColor}">${school.desempenho2.toFixed(1)}</span>
                            <span class="text-sm ${academicColor}">${academicTrend}: ${school.variacao_acad > 0 ? '+' : ''}${school.variacao_acad.toFixed(1)}</span>
                        </div>
                        <div class="mt-2 text-xs text-slate-500">1º Bimestre: ${school.desempenho1.toFixed(1)}</div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-slate-800 mb-2">Frequência dos Alunos</h4>
                        <div class="flex items-center justify-between">
                            <span class="text-2xl font-bold ${frequencyColor}">${school.frequencia2.toFixed(1)}%</span>
                            <span class="text-sm ${frequencyColor}">${frequencyTrend}: ${school.variacao_freq > 0 ? '+' : ''}${school.variacao_freq.toFixed(1)}%</span>
                        </div>
                        <div class="mt-2 text-xs text-slate-500">1º Bimestre: ${school.frequencia1.toFixed(1)}%</div>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">💡 Insight Automático</h4>
                    <p class="text-sm text-blue-700">
                        ${generateAutomaticInsight(school)}
                    </p>
                </div>
            `;
        }

        function generateAutomaticInsight(school) {
            const academicGrowth = school.variacao_acad;
            const frequencyGrowth = school.variacao_freq;
            
            if (academicGrowth >= 2 && frequencyGrowth >= 5) {
                return `Excelente evolução! A escola apresentou crescimento significativo tanto no desempenho acadêmico (+${academicGrowth.toFixed(1)}) quanto na frequência (+${frequencyGrowth.toFixed(1)}%). Modelo de referência para outras unidades.`;
            } else if (academicGrowth >= 1 && frequencyGrowth >= 0) {
                return `Evolução positiva no desempenho acadêmico (+${academicGrowth.toFixed(1)}). Recomenda-se manter as estratégias atuais e focar em ações para melhorar a frequência dos alunos.`;
            } else if (academicGrowth < 0 && frequencyGrowth < 0) {
                return `Situação que requer atenção. Ambos os indicadores apresentaram queda. Sugestão: revisão das estratégias pedagógicas e implementação de ações específicas para engajamento dos alunos.`;
            } else {
                return `Desempenho misto. Enquanto um indicador melhorou, outro precisa de atenção. Recomenda-se análise detalhada dos fatores que influenciam cada métrica.`;
            }
        }

        // Simulador principal com IA
        const slidersMain = {
            frequencia: null,
            professorFreq: null,
            plataformas: null,
            formacao: null,
            saresp: null
        };

        const valuesMain = {
            frequencia: null,
            professorFreq: null,
            plataformas: null,
            formacao: null,
            saresp: null
        };

        let projectionChartMain;

        function initializeMainSimulator() {
            const schoolSelector = document.getElementById('school-selector-main');
            if (!schoolSelector) return;

            // Popular seletor de escolas
            schoolDataMain.forEach(school => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.nome;
                schoolSelector.appendChild(option);
            });

            // Configurar sliders
            slidersMain.frequencia = document.getElementById('frequencia-slider-main');
            slidersMain.professorFreq = document.getElementById('professor-freq-slider-main');
            slidersMain.plataformas = document.getElementById('plataformas-slider-main');
            slidersMain.formacao = document.getElementById('formacao-slider-main');
            slidersMain.saresp = document.getElementById('saresp-slider-main');

            valuesMain.frequencia = document.getElementById('frequencia-value-main');
            valuesMain.professorFreq = document.getElementById('professor-freq-value-main');
            valuesMain.plataformas = document.getElementById('plataformas-value-main');
            valuesMain.formacao = document.getElementById('formacao-value-main');
            valuesMain.saresp = document.getElementById('saresp-value-main');

            // Configurar botão de IA
            const generatePlanBtn = document.getElementById('generate-plan-btn-main');
            if (generatePlanBtn) {
                generatePlanBtn.addEventListener('click', generateAIPlan);
            }

            // Eventos
            schoolSelector.addEventListener('change', (e) => {
                const school = schoolDataMain.find(s => s.id == e.target.value);
                if (school) {
                    slidersMain.frequencia.value = school.frequencia2;
                    slidersMain.professorFreq.value = 95; // Valor padrão para frequência professor
                    slidersMain.plataformas.value = 8.5;
                    slidersMain.formacao.value = 80; // 80% como padrão para formação
                    slidersMain.saresp.value = 70; // 70% IC como padrão
                    updateMainSimulator();
                }
            });

            Object.values(slidersMain).forEach(slider => {
                if (slider) slider.addEventListener('input', updateMainSimulator);
            });

            updateMainSimulator();
        }

        function updateMainSimulator() {
            if (!slidersMain.frequencia) return;

            const freq = parseFloat(slidersMain.frequencia.value);
            const profFreq = parseFloat(slidersMain.professorFreq.value);
            const plat = parseFloat(slidersMain.plataformas.value);
            const formacao = parseFloat(slidersMain.formacao.value);
            const saresp = parseFloat(slidersMain.saresp.value);

            valuesMain.frequencia.textContent = freq.toFixed(1) + '%';
            valuesMain.professorFreq.textContent = profFreq.toFixed(1) + '%';
            valuesMain.plataformas.textContent = plat.toFixed(1);
            valuesMain.formacao.textContent = formacao.toFixed(0) + '%';
            valuesMain.saresp.textContent = saresp.toFixed(0) + '%';

            // Aplicar regras do Super BI 2025
            // Aluno Presente (AP) - Peso máximo: 1.5
            // Crescimento exponencial até 97% de frequência
            const freqNorm = freq / 100;
            let notaAlunoPresente;
            if (freqNorm >= 0.97) {
                notaAlunoPresente = 1.5;
            } else {
                // Crescimento exponencial aproximado
                notaAlunoPresente = 1.5 * Math.pow(freqNorm / 0.97, 2);
            }

            // Professor Presente (PP) - Peso máximo: 1.0
            // 100% de frequência = peso máximo
            const profFreqNorm = profFreq / 100;
            let notaProfPresente;
            if (profFreqNorm >= 1.0) {
                notaProfPresente = 1.0;
            } else {
                notaProfPresente = 1.0 * Math.pow(profFreqNorm, 2);
            }

            // Plataformas (PLAT) - Peso máximo: 2.0
            // Normalização linear até nota 10
            const notaPlataformas = Math.min(2.0 * (plat / 10), 2.0);

            // Formação (FORM) - Peso máximo: 2.0
            // Baseado no percentual de formação (PdA + Multiplica)
            const formacaoNorm = formacao / 100;
            const notaFormacao = 2.0 * Math.min(formacaoNorm, 1);

            // SARESP - Peso máximo: 3.0
            // IC da meta (percentual direto)
            const icSaresp = saresp / 100;
            const notaSaresp = 3.0 * Math.min(icSaresp, 1);

            // Apoio Presencial (APOIO) - Peso máximo: 0.5
            // Valor fixo para simulação (pode ser ajustado)
            const apoioRealizado = 0.8; // 80% dos apoios realizados
            const notaApoio = 0.5 * Math.min(apoioRealizado, 1);

            // Ajuste de Desigualdades (AJ) - Peso máximo: 1.0
            // Valores médios para simulação
            const pctVuln = 0.3; // 30% vulneráveis
            const pontosTamanho = 0.15; // Escola média
            const pontosTipo = 0.1; // Regular
            const pontosCiclo = 0.1; // Anos Finais
            const ajusteDesigualdades = Math.min(pctVuln + pontosTamanho + pontosTipo + pontosCiclo, 1.0);

            // Nota Final Super BI (máximo teórico: 11.0)
            const notaFinal = notaAlunoPresente + notaProfPresente + notaPlataformas + 
                             notaFormacao + notaSaresp + notaApoio + ajusteDesigualdades;
            
            document.getElementById('projected-score-main').textContent = notaFinal.toFixed(2);

            // Atualizar gráfico com componentes do Super BI 2025
            if (projectionChartMain) projectionChartMain.destroy();
            const ctx = document.getElementById('projectionChartMain');
            if (ctx) {
                projectionChartMain = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Aluno Presente', 'Prof. Presente', 'Plataformas', 'Formação', 'SARESP', 'Apoio', 'Ajuste Desig.'],
                        datasets: [{
                            label: 'Pontuação por Componente',
                            data: [notaAlunoPresente, notaProfPresente, notaPlataformas, notaFormacao, notaSaresp, notaApoio, ajusteDesigualdades],
                            backgroundColor: [
                                'rgba(79, 70, 229, 0.6)', // Aluno Presente
                                'rgba(34, 197, 94, 0.6)', // Professor Presente
                                'rgba(217, 119, 6, 0.6)', // Plataformas
                                'rgba(219, 39, 119, 0.6)', // Formação
                                'rgba(30, 64, 175, 0.6)', // SARESP
                                'rgba(168, 85, 247, 0.6)', // Apoio
                                'rgba(107, 114, 128, 0.6)' // Ajuste
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: { 
                            x: { 
                                beginAtZero: true, 
                                max: 3.5,
                                title: {
                                    display: true,
                                    text: 'Pontuação por Componente'
                                }
                            }
                        },
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const maxValues = [1.5, 1.0, 2.0, 2.0, 3.0, 0.5, 1.0];
                                        return `Máximo: ${maxValues[context.dataIndex]}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Função para gerar plano de ação com IA
        async function generateAIPlan() {
            const btn = document.getElementById('generate-plan-btn-main');
            const btnText = document.getElementById('plan-btn-text-main');
            const btnSpinner = document.getElementById('plan-btn-spinner-main');
            const container = document.getElementById('ai-plan-container-main');
            const content = document.getElementById('ai-plan-content-main');

            if (!btn || !container) return;

            // Estado de carregamento
            btn.disabled = true;
            btnText.textContent = 'Gerando Plano...';
            btnSpinner.classList.remove('hidden');

            try {
                const schoolSelector = document.getElementById('school-selector-main');
                const selectedSchool = schoolDataMain.find(s => s.id == schoolSelector.value);
                
                const currentScore = parseFloat(document.getElementById('projected-score-main').textContent);
                const freq = parseFloat(slidersMain.frequencia.value);
                const profFreq = parseFloat(slidersMain.professorFreq.value);
                const plat = parseFloat(slidersMain.plataformas.value);
                const formacao = parseFloat(slidersMain.formacao.value);
                const saresp = parseFloat(slidersMain.saresp.value);
                
                // Simular resposta da IA (substitua por chamada real à API do Gemini)
                const prompt = `Como especialista em educação, crie um plano de ação para a escola "${selectedSchool.nome}" (tipo: ${selectedSchool.tipo}) com base nos seguintes dados do Super BI 2025:
                
                - Nota projetada Super BI: ${currentScore.toFixed(2)}
                - Frequência de Alunos: ${freq.toFixed(1)}%
                - Frequência de Professores: ${profFreq.toFixed(1)}%
                - Nota Plataformas: ${plat.toFixed(1)}
                - Formação (PdA + Multiplica): ${formacao.toFixed(0)}%
                - SARESP (IC da Meta): ${saresp.toFixed(0)}%
                - Evolução acadêmica: ${selectedSchool.variacao_acad > 0 ? '+' : ''}${selectedSchool.variacao_acad.toFixed(1)}
                - Evolução frequência: ${selectedSchool.variacao_freq > 0 ? '+' : ''}${selectedSchool.variacao_freq.toFixed(1)}%
                
                Forneça um plano estruturado com ações específicas, priorizadas e com prazos.`;

                // Simular delay da API
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Resposta simulada (substitua por chamada real à API)
                const aiResponse = generateMockAIPlan(selectedSchool, currentScore, freq, profFreq, plat, formacao, saresp);

                content.innerHTML = aiResponse;
                container.classList.remove('hidden');

            } catch (error) {
                console.error('Erro ao gerar plano de ação:', error);
                content.innerHTML = '<p class="text-red-600">❌ Erro ao gerar plano de ação. Tente novamente.</p>';
                container.classList.remove('hidden');
            } finally {
                // Restaurar estado do botão
                btn.disabled = false;
                btnText.textContent = '✨ Sugerir Plano de Ação';
                btnSpinner.classList.add('hidden');
            }
        }

        function generateMockAIPlan(school, score, freq, profFreq, plat, formacao, saresp) {
            const priorityActions = [];
            
            // Análise baseada na frequência de alunos
            if (freq < 90) {
                priorityActions.push({
                    title: "🎯 Melhorar Frequência de Alunos",
                    actions: [
                        "Implementar sistema de monitoramento diário de faltas",
                        "Criar programa de mentoria estudantil",
                        "Desenvolver atividades extracurriculares atrativas",
                        "Estabelecer comunicação direta com famílias"
                    ],
                    deadline: "30 dias"
                });
            }
            
            // Análise baseada na frequência de professores
            if (profFreq < 95) {
                priorityActions.push({
                    title: "�‍🏫 Fortalecer Presença Docente",
                    actions: [
                        "Revisar políticas de substituição de professores",
                        "Implementar programa de bem-estar docente",
                        "Melhorar condições de trabalho e infraestrutura",
                        "Criar sistema de acompanhamento de faltas docentes"
                    ],
                    deadline: "20 dias"
                });
            }
            
            // Análise baseada nas plataformas
            if (plat < 7.0) {
                priorityActions.push({
                    title: "💻 Intensificar Uso de Plataformas Digitais",
                    actions: [
                        "Capacitar professores no uso das plataformas",
                        "Aumentar engajamento dos alunos nas atividades online",
                        "Monitorar regularmente o progresso nas plataformas",
                        "Criar cronograma semanal de atividades digitais"
                    ],
                    deadline: "45 dias"
                });
            }
            
            // Análise baseada na formação
            if (formacao < 80) {
                priorityActions.push({
                    title: "📚 Melhorar Formação Continuada",
                    actions: [
                        "Aumentar participação no Programa de Ação (PdA)",
                        "Intensificar adesão ao Programa Multiplica",
                        "Organizar grupos de estudo internos",
                        "Estabelecer metas mensais de formação"
                    ],
                    deadline: "60 dias"
                });
            }
            
            // Análise baseada no SARESP
            if (saresp < 70) {
                priorityActions.push({
                    title: "📊 Preparação para SARESP",
                    actions: [
                        "Implementar simulados mensais",
                        "Reforçar habilidades específicas avaliadas",
                        "Capacitar professores em estratégias de avaliação",
                        "Criar grupos de estudo focados nas competências do SARESP"
                    ],
                    deadline: "90 dias"
                });
            }
            
            // Se a nota geral está baixa
            if (score < 8.0) {
                priorityActions.push({
                    title: "🏆 Estratégia Integrada Super BI 2025",
                    actions: [
                        "Criar comitê de acompanhamento do Super BI",
                        "Estabelecer metas semanais por componente",
                        "Implementar reuniões de monitoramento quinzenais",
                        "Desenvolver sistema de reconhecimento e incentivos"
                    ],
                    deadline: "15 dias"
                });
            }

            let planHTML = `
                <h5 class="font-semibold text-slate-800 mb-3">📋 Plano de Ação Personalizado - ${school.nome}</h5>
                <div class="text-sm text-slate-600 mb-4 p-3 bg-gray-50 rounded">
                    <strong>Situação Atual (Super BI 2025):</strong><br>
                    • Nota projetada: <span class="font-semibold">${score.toFixed(2)}</span><br>
                    • Frequência Alunos: <span class="font-semibold">${freq.toFixed(1)}%</span><br>
                    • Frequência Professores: <span class="font-semibold">${profFreq.toFixed(1)}%</span><br>
                    • Plataformas: <span class="font-semibold">${plat.toFixed(1)}</span><br>
                    • Formação: <span class="font-semibold">${formacao.toFixed(0)}%</span><br>
                    • SARESP (IC): <span class="font-semibold">${saresp.toFixed(0)}%</span>
                </div>
            `;

            priorityActions.forEach((action, index) => {
                planHTML += `
                    <div class="mb-4 p-3 border-l-4 border-blue-400 bg-blue-50">
                        <h6 class="font-medium text-blue-800 mb-2">${action.title}</h6>
                        <ul class="text-sm text-blue-700 mb-2">
                            ${action.actions.map(item => `<li>• ${item}</li>`).join('')}
                        </ul>
                        <div class="text-xs text-blue-600 font-medium">⏱️ Prazo: ${action.deadline}</div>
                    </div>
                `;
            });

            planHTML += `
                <div class="mt-4 p-3 bg-green-50 border-l-4 border-green-400">
                    <h6 class="font-medium text-green-800 mb-2">🎯 Meta de Melhoria</h6>
                    <p class="text-sm text-green-700">
                        Com a implementação dessas ações, a projeção é atingir uma nota Super BI de 
                        <strong>${(score + 0.5).toFixed(2)}</strong> no próximo bimestre.
                    </p>
                </div>
            `;

            return planHTML;
        }

        // Inicialização completa
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando funcionalidades avançadas...');
            
            setTimeout(() => {
                createNetworkEvolutionChartMain();
                populateMainTable(schoolDataMain);
                setupMainTableSorting();
                initializeEvolutionAnalysis();
                initializeMainSimulator();
                
                console.log('✅ Todas as funcionalidades avançadas inicializadas');
            }, 1000);
        });
    </script>
    <script>
        // Inicialização específica do index
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Inicializando Dashboard Principal...');

            try {
                // Aguardar carregamento dos dados
                const dados = await carregarDados();
                console.log('Dados carregados:', dados);

                if (dados && dados.escolas) {
                    console.log('Atualizando KPIs...');
                    // Atualizar KPIs dinâmicos
                    atualizarKPIs();

                    console.log('Criando gráficos...');
                    // Criar gráficos do dashboard
                    setTimeout(() => {
                        criarGraficoComparativo('graficoComparativo');
                        criarGraficoPerformanceGeral();
                        console.log('Gráficos criados');
                    }, 500);
                } else {
                    console.error('Dados não carregados corretamente');
                }
            } catch (error) {
                console.error('Erro na inicialização:', error);
            }

            console.log('✅ Dashboard Principal inicializado');
        });

        // Gráfico de performance geral das 26 escolas
        function criarGraficoPerformanceGeral() {
            const canvas = document.getElementById('graficoPerformanceGeral');
            if (!canvas) {
                console.warn('Canvas graficoPerformanceGeral não encontrado');
                return;
            }

            // Dados das 26 escolas com 1º e 2º bimestre
            const escolasData = [
                { nome: "PEI - José Luiz", tipo: "PEI", bi1: 8.1, bi2: 8.3 },
                { nome: "EE Luiz Marcari", tipo: "Regular", bi1: 6.6, bi2: 8.6 },
                { nome: "PEI - Nestor Gomes", tipo: "PEI", bi1: 8.3, bi2: 9.9 },
                { nome: "EE Dr. Mário Lins", tipo: "Regular", bi1: 7.8, bi2: 9.3 },
                { nome: "EE Prof. Plínio Berardo", tipo: "Regular", bi1: 6.6, bi2: 8.6 },
                { nome: "PEI - Domingos Paro", tipo: "PEI", bi1: 8.1, bi2: 10.0 },
                { nome: "PEI - Maria Falconi", tipo: "PEI", bi1: 8.7, bi2: 10.0 },
                { nome: "EE Maurício Montecchi", tipo: "Regular", bi1: 7.4, bi2: 9.9 },
                { nome: "EE Orminda Guimarães", tipo: "Regular", bi1: 7.0, bi2: 9.5 },
                { nome: "EE Prof. Basílio Rodrigues", tipo: "Regular", bi1: 6.6, bi2: 8.8 },
                { nome: "PEI - Dolores Belém", tipo: "PEI", bi1: 7.9, bi2: 9.5 },
                { nome: "EE Profª Dolores Martins", tipo: "Regular", bi1: 6.6, bi2: 9.2 },
                { nome: "EE Profª Josepha Castro", tipo: "Regular", bi1: 6.2, bi2: 9.4 },
                { nome: "EE Profª Yolanda Sichieri", tipo: "Regular", bi1: 7.1, bi2: 9.5 },
                { nome: "EE Dona Adélia Frascino", tipo: "Regular", bi1: 7.8, bi2: 10.0 },
                { nome: "EE Anna Passamonti", tipo: "Regular", bi1: 6.0, bi2: 9.2 },
                { nome: "PEI - Antônio Furlan", tipo: "PEI", bi1: 8.0, bi2: 9.8 },
                { nome: "EE Prof. Bruno Pieroni", tipo: "Regular", bi1: 7.6, bi2: 9.8 },
                { nome: "EE Profª Edith Silveira", tipo: "Regular", bi1: 6.4, bi2: 8.5 },
                { nome: "EE Ferrúcio Chiaratti", tipo: "Regular", bi1: 5.9, bi2: 9.0 },
                { nome: "EE Dr. Isaías Ferreira", tipo: "Regular", bi1: 6.7, bi2: 9.6 },
                { nome: "PEI - Maria Conceição", tipo: "PEI", bi1: 7.2, bi2: 9.4 },
                { nome: "EE Profª Nícia Giraldi", tipo: "Regular", bi1: 7.1, bi2: 9.2 },
                { nome: "PEI - Winston Churchill", tipo: "PEI", bi1: 7.2, bi2: 9.5 },
                { nome: "PEI - Maria Élyde", tipo: "PEI", bi1: 8.3, bi2: 10.0 },
                { nome: "EE Odulfo Guimarães", tipo: "Regular", bi1: 7.0, bi2: 9.3 }
            ];

            const ctx = canvas.getContext('2d');
            
            // Cores diferentes para PEI e Regulares
            const cores1Bi = escolasData.map(escola => 
                escola.tipo === "PEI" ? 'rgba(59, 130, 246, 0.7)' : 'rgba(34, 197, 94, 0.7)'
            );
            const cores2Bi = escolasData.map(escola => 
                escola.tipo === "PEI" ? 'rgba(37, 99, 235, 0.8)' : 'rgba(22, 163, 74, 0.8)'
            );
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: escolasData.map(escola => escola.nome),
                    datasets: [
                        {
                            label: '1º Bimestre',
                            data: escolasData.map(escola => escola.bi1),
                            backgroundColor: cores1Bi,
                            borderColor: cores1Bi.map(cor => cor.replace('0.7', '1')),
                            borderWidth: 1.5,
                            barThickness: 'flex',
                            maxBarThickness: 40
                        },
                        {
                            label: '2º Bimestre',
                            data: escolasData.map(escola => escola.bi2),
                            backgroundColor: cores2Bi,
                            borderColor: cores2Bi.map(cor => cor.replace('0.8', '1')),
                            borderWidth: 1.5,
                            barThickness: 'flex',
                            maxBarThickness: 40
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolução do Desempenho: 1º vs 2º Bimestre (26 Escolas)',
                            font: { size: 16, weight: 'bold' },
                            padding: 20
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const escola = escolasData[context[0].dataIndex];
                                    return `${escola.nome} (${escola.tipo})`;
                                },
                                label: function(context) {
                                    const evolucao = escolasData[context.dataIndex].bi2 - escolasData[context.dataIndex].bi1;
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)} (${evolucao >= 0 ? '+' : ''}${evolucao.toFixed(1)})`;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(255, 255, 255, 0.3)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 10.5,
                            ticks: {
                                stepSize: 1,
                                font: { size: 11 }
                            },
                            title: {
                                display: true,
                                text: 'Nota de Desempenho',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutCubic'
                    }
                }
            });
        }

        // ===== FUNCIONALIDADES DO SISTEMA REGINA AVANÇADO =====
        
        // Dados das escolas para tabela e simulador avançado
        const schoolDataAdvanced = [
            { id: 1, nome: "PEI EE Prof. José Luiz de Siqueira", tipo: "PEI", desempenho1: 8.1, desempenho2: 8.3, frequencia1: 93.2, frequencia2: 94.1, alunos: 742 },
            { id: 2, nome: "EE Luiz Marcari", tipo: "Regular", desempenho1: 6.6, desempenho2: 8.6, frequencia1: 71.3, frequencia2: 86.1, alunos: 249 },
            { id: 3, nome: "PEI EE Prof. Nestor Gomes de Araújo", tipo: "PEI", desempenho1: 8.3, desempenho2: 9.9, frequencia1: 81.8, frequencia2: 90.6, alunos: 306 },
            { id: 4, nome: "EE Dr. Mário Lins", tipo: "Regular", desempenho1: 7.8, desempenho2: 9.3, frequencia1: 85.8, frequencia2: 86.7, alunos: 105 },
            { id: 5, nome: "EE Prof. Plínio Berardo", tipo: "Regular", desempenho1: 6.6, desempenho2: 8.6, frequencia1: 73.7, frequencia2: 75.2, alunos: 1038 },
            { id: 6, nome: "PEI EE Domingos Paro", tipo: "PEI", desempenho1: 8.1, desempenho2: 10.0, frequencia1: 88.0, frequencia2: 93.2, alunos: 254 },
            { id: 7, nome: "PEI EE Maria Falconi de Felício", tipo: "PEI", desempenho1: 8.7, desempenho2: 10.0, frequencia1: 85.9, frequencia2: 90.6, alunos: 396 },
            { id: 8, nome: "EE Maurício Montecchi", tipo: "Regular", desempenho1: 7.4, desempenho2: 9.9, frequencia1: 91.0, frequencia2: 92.0, alunos: 815 },
            { id: 9, nome: "EE Orminda Guimarães Cotrim", tipo: "Regular", desempenho1: 7.0, desempenho2: 9.5, frequencia1: 84.4, frequencia2: 84.5, alunos: 779 },
            { id: 10, nome: "EE Prof. Basílio Rodrigues da Silva", tipo: "Regular", desempenho1: 6.6, desempenho2: 8.8, frequencia1: 83.4, frequencia2: 88.4, alunos: 571 },
            { id: 11, nome: "PEI EE Profª Dolores Belém Novaes", tipo: "PEI", desempenho1: 7.9, desempenho2: 9.5, frequencia1: 82.8, frequencia2: 89.2, alunos: 503 },
            { id: 12, nome: "EE Profª Dolores Martins de Castro", tipo: "Regular", desempenho1: 6.6, desempenho2: 9.2, frequencia1: 89.7, frequencia2: 91.5, alunos: 148 },
            { id: 13, nome: "EE Profª Josepha Castro", tipo: "Regular", desempenho1: 6.2, desempenho2: 9.4, frequencia1: 82.9, frequencia2: 82.3, alunos: 527 },
            { id: 14, nome: "EE Profª Yolanda Luiz Sichieri", tipo: "Regular", desempenho1: 7.1, desempenho2: 9.5, frequencia1: 71.9, frequencia2: 78.6, alunos: 642 },
            { id: 15, nome: "EE Dona Adélia Frascino", tipo: "Regular", desempenho1: 7.8, desempenho2: 10.0, frequencia1: 91.5, frequencia2: 92.6, alunos: 50 },
            { id: 16, nome: "EE Anna Passamonti Balardin", tipo: "Regular", desempenho1: 6.0, desempenho2: 9.2, frequencia1: 73.1, frequencia2: 78.4, alunos: 968 },
            { id: 17, nome: "PEI EE Dr. Antônio Furlan Júnior", tipo: "PEI", desempenho1: 8.0, desempenho2: 9.8, frequencia1: 88.4, frequencia2: 89.3, alunos: 521 },
            { id: 18, nome: "EE Prof. Bruno Pieroni", tipo: "Regular", desempenho1: 7.6, desempenho2: 9.8, frequencia1: 82.9, frequencia2: 85.5, alunos: 645 },
            { id: 19, nome: "EE Profª Edith Silveira Dalmaso", tipo: "Regular", desempenho1: 6.4, desempenho2: 8.5, frequencia1: 75.3, frequencia2: 90.8, alunos: 1058 },
            { id: 20, nome: "EE Ferrúcio Chiaratti", tipo: "Regular", desempenho1: 5.9, desempenho2: 9.0, frequencia1: 70.9, frequencia2: 74.8, alunos: 902 },
            { id: 21, nome: "EE Dr. Isaías José Ferreira", tipo: "Regular", desempenho1: 6.7, desempenho2: 9.6, frequencia1: 78.9, frequencia2: 88.0, alunos: 631 },
            { id: 22, nome: "PEI EE Profª Maria Conceição R. Silva Magon", tipo: "PEI", desempenho1: 7.2, desempenho2: 9.4, frequencia1: 70.8, frequencia2: 93.4, alunos: 236 },
            { id: 23, nome: "EE Profª Nícia Fabíola Zanutto Giraldi", tipo: "Regular", desempenho1: 7.1, desempenho2: 9.2, frequencia1: 80.9, frequencia2: 80.5, alunos: 769 },
            { id: 24, nome: "PEI EE Winston Churchill", tipo: "PEI", desempenho1: 7.2, desempenho2: 9.5, frequencia1: 80.1, frequencia2: 87.6, alunos: 386 },
            { id: 25, nome: "PEI EE Profª Maria Élyde Mônaco dos Santos", tipo: "PEI", desempenho1: 8.3, desempenho2: 10.0, frequencia1: 82.2, frequencia2: 88.2, alunos: 229 },
            { id: 26, nome: "EE Odulfo de Oliveira Guimarães", tipo: "Regular", desempenho1: 7.0, desempenho2: 9.3, frequencia1: 76.2, frequencia2: 80.0, alunos: 897 }
        ].map(d => ({
            ...d,
            variacao_acad: parseFloat((d.desempenho2 - d.desempenho1).toFixed(1)),
            variacao_freq: parseFloat((d.frequencia2 - d.frequencia1).toFixed(1))
        }));

        // Gráfico de evolução da rede
        function createNetworkEvolutionChart() {
            const ctx = document.getElementById('networkEvolutionChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1º Bimestre', '2º Bimestre'],
                    datasets: [{
                        label: 'Média de Desempenho',
                        data: [7.6, 9.1],
                        backgroundColor: 'rgba(79, 70, 229, 0.7)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'Média de Frequência (%)',
                        data: [80.7, 85.9],
                        backgroundColor: 'rgba(13, 148, 136, 0.7)',
                        borderColor: 'rgba(13, 148, 136, 1)',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Média de Desempenho' } },
                        y1: { beginAtZero: false, position: 'right', title: { display: true, text: 'Média de Frequência (%)' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        // Popular tabela com dados das escolas
        function populateAdvancedTable(data) {
            const tableBody = document.getElementById('school-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            data.forEach(school => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${school.nome}</td>
                    <td class="px-6 py-4 text-center">${school.desempenho2.toFixed(1)}</td>
                    <td class="px-6 py-4 text-center ${school.variacao_acad >= 0 ? 'text-green-600' : 'text-red-600'}">${school.variacao_acad > 0 ? '+' : ''}${school.variacao_acad.toFixed(1)}</td>
                    <td class="px-6 py-4 text-center">${school.frequencia2.toFixed(1)}%</td>
                    <td class="px-6 py-4 text-center ${school.variacao_freq >= 0 ? 'text-green-600' : 'text-red-600'}">${school.variacao_freq > 0 ? '+' : ''}${school.variacao_freq.toFixed(1)}%</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Ordenação da tabela
        let currentSortAdvanced = { key: 'nome', direction: 'asc' };
        function setupTableSorting() {
            document.querySelectorAll('.table-header-sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sort;
                    const direction = (currentSortAdvanced.key === sortKey && currentSortAdvanced.direction === 'desc') ? 'asc' : 'desc';
                    currentSortAdvanced = { key: sortKey, direction };
                    const sortedData = [...schoolDataAdvanced].sort((a, b) => {
                        if (a[sortKey] < b[sortKey]) return direction === 'asc' ? -1 : 1;
                        if (a[sortKey] > b[sortKey]) return direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                    populateAdvancedTable(sortedData);
                });
            });
        }

        // Simulador avançado
        const slidersAdvanced = {
            frequencia: null,
            aprovacao: null,
            rendimento: null,
            plataformas: null,
            saresp: null
        };

        const valuesAdvanced = {
            frequencia: null,
            aprovacao: null,
            rendimento: null,
            plataformas: null,
            saresp: null
        };

        let projectionChartAdvanced;

        function initializeAdvancedSimulator() {
            const schoolSelector = document.getElementById('school-selector-advanced');
            if (!schoolSelector) return;

            // Popular seletor de escolas
            schoolDataAdvanced.forEach(school => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.nome;
                schoolSelector.appendChild(option);
            });

            // Configurar sliders
            slidersAdvanced.frequencia = document.getElementById('frequencia-slider-advanced');
            slidersAdvanced.aprovacao = document.getElementById('aprovacao-slider-advanced');
            slidersAdvanced.rendimento = document.getElementById('rendimento-slider-advanced');
            slidersAdvanced.plataformas = document.getElementById('plataformas-slider-advanced');
            slidersAdvanced.saresp = document.getElementById('saresp-slider-advanced');

            valuesAdvanced.frequencia = document.getElementById('frequencia-value-advanced');
            valuesAdvanced.aprovacao = document.getElementById('aprovacao-value-advanced');
            valuesAdvanced.rendimento = document.getElementById('rendimento-value-advanced');
            valuesAdvanced.plataformas = document.getElementById('plataformas-value-advanced');
            valuesAdvanced.saresp = document.getElementById('saresp-value-advanced');

            // Eventos
            schoolSelector.addEventListener('change', (e) => {
                const school = schoolDataAdvanced.find(s => s.id == e.target.value);
                if (school) {
                    slidersAdvanced.frequencia.value = school.frequencia2;
                    slidersAdvanced.aprovacao.value = 92;
                    slidersAdvanced.rendimento.value = school.desempenho2;
                    slidersAdvanced.plataformas.value = 8.5;
                    slidersAdvanced.saresp.value = 7.8;
                    updateAdvancedSimulator();
                }
            });

            Object.values(slidersAdvanced).forEach(slider => {
                if (slider) slider.addEventListener('input', updateAdvancedSimulator);
            });

            updateAdvancedSimulator();
        }

        function updateAdvancedSimulator() {
            if (!slidersAdvanced.frequencia) return;

            const freq = parseFloat(slidersAdvanced.frequencia.value);
            const aprov = parseFloat(slidersAdvanced.aprovacao.value);
            const rend = parseFloat(slidersAdvanced.rendimento.value);
            const plat = parseFloat(slidersAdvanced.plataformas.value);
            const saresp = parseFloat(slidersAdvanced.saresp.value);

            valuesAdvanced.frequencia.textContent = freq.toFixed(1);
            valuesAdvanced.aprovacao.textContent = aprov.toFixed(1);
            valuesAdvanced.rendimento.textContent = rend.toFixed(1);
            valuesAdvanced.plataformas.textContent = plat.toFixed(1);
            valuesAdvanced.saresp.textContent = saresp.toFixed(1);

            const pesos = { freq: 1.5, aprov: 1.0, rend: 2.0, plat: 2.0, saresp: 3.0, formacao: 2.0, apoio: 0.5 };
            const totalPeso = Object.values(pesos).reduce((a, b) => a + b, 0);

            const notaFreq = (freq / 100) * pesos.freq;
            const notaAprov = (aprov / 100) * pesos.aprov;
            const notaRend = (rend / 10) * pesos.rend;
            const notaPlat = (plat / 10) * pesos.plat;
            const notaSaresp = (saresp / 10) * pesos.saresp;
            
            const notaFormacao = 0.8 * pesos.formacao;
            const notaApoio = 0.7 * pesos.apoio;

            const notaFinal = (notaFreq + notaAprov + notaRend + notaPlat + notaSaresp + notaFormacao + notaApoio) / totalPeso * 10;
            
            document.getElementById('projected-score-advanced').textContent = notaFinal.toFixed(2);

            // Atualizar gráfico
            if (projectionChartAdvanced) projectionChartAdvanced.destroy();
            const ctx = document.getElementById('projectionChartAdvanced');
            if (ctx) {
                projectionChartAdvanced = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Frequência', 'Aprovação', 'Rendimento', 'Plataformas', 'SARESP'],
                        datasets: [{
                            label: 'Pontuação Contribuinte',
                            data: [notaFreq, notaAprov, notaRend, notaPlat, notaSaresp],
                            backgroundColor: [
                                'rgba(79, 70, 229, 0.6)',
                                'rgba(13, 148, 136, 0.6)',
                                'rgba(217, 119, 6, 0.6)',
                                'rgba(219, 39, 119, 0.6)',
                                'rgba(30, 64, 175, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: { x: { beginAtZero: true, max: 3 } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        // Inicializar funcionalidades avançadas quando dados estiverem carregados
        document.addEventListener('dadosCarregados', function() {
            createNetworkEvolutionChart();
            populateAdvancedTable(schoolDataAdvanced);
            setupTableSorting();
            initializeAdvancedSimulator();
        });
    </script>
</body>
</html>